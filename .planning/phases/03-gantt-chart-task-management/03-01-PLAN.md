---
phase: 03-gantt-chart-task-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/ui/checkbox.tsx
  - src/components/ui/switch.tsx
  - src/lib/tasks.ts
  - src/lib/companies.ts
  - src/lib/gantt-utils.ts
autonomous: true

must_haves:
  truths:
    - "getCompaniesWithTasks returns all companies with nested tasks sorted by deadline"
    - "createTask, updateTask, deleteTask perform correct Supabase CRUD"
    - "getTimelineRange returns exactly 14 date strings starting from Monday of the anchor week"
    - "isDateInRange correctly identifies dates within a start/end interval"
  artifacts:
    - path: "src/lib/tasks.ts"
      provides: "createTask, updateTask, deleteTask, getCompaniesWithTasks"
      exports: ["createTask", "updateTask", "deleteTask"]
    - path: "src/lib/gantt-utils.ts"
      provides: "Timeline date range generation and column index utilities"
      exports: ["getTimelineRange", "getColumnIndex", "isDateInRange", "formatDayHeader"]
    - path: "src/components/ui/checkbox.tsx"
      provides: "shadcn/ui Checkbox component"
    - path: "src/components/ui/switch.tsx"
      provides: "shadcn/ui Switch component"
  key_links:
    - from: "src/lib/tasks.ts"
      to: "src/lib/supabase.ts"
      via: "supabase client import"
      pattern: "import.*supabase.*from.*@/lib/supabase"
    - from: "src/lib/gantt-utils.ts"
      to: "date-fns"
      via: "eachDayOfInterval, startOfWeek, addDays, differenceInCalendarDays"
      pattern: "import.*from.*date-fns"
---

<objective>
Install required shadcn/ui components, extend the task data access layer with full CRUD operations and a company-with-tasks query, and create the gantt-utils utility module for timeline date range generation.

Purpose: Provides the data foundation and utility layer that all Gantt UI components will depend on. No UI can be built without task CRUD and timeline date calculations.
Output: Extended tasks.ts with createTask/updateTask/deleteTask, extended companies.ts with getCompaniesWithTasks, new gantt-utils.ts, and checkbox/switch UI components installed.
</objective>

<execution_context>
@C:\Users\bstei\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\bstei\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-gantt-chart-task-management/03-RESEARCH.md
@src/lib/tasks.ts
@src/lib/companies.ts
@src/lib/supabase.ts
@src/lib/dates.ts
@src/lib/overdue.ts
@src/types/database.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install shadcn/ui checkbox and switch components</name>
  <files>src/components/ui/checkbox.tsx, src/components/ui/switch.tsx</files>
  <action>
    Run the shadcn CLI to install checkbox and switch components:
    ```
    npx shadcn@latest add checkbox switch -y
    ```
    These are needed for task completion toggle (checkbox) and urgency toggle (switch) in the task edit dialog built in Plan 03.
    Verify the files are created at src/components/ui/checkbox.tsx and src/components/ui/switch.tsx.
  </action>
  <verify>
    - `ls src/components/ui/checkbox.tsx src/components/ui/switch.tsx` shows both files exist
    - `npx next build` compiles without errors (or at minimum `npx tsc --noEmit` passes)
  </verify>
  <done>checkbox.tsx and switch.tsx exist in src/components/ui/ and import without errors</done>
</task>

<task type="auto">
  <name>Task 2: Extend data access layer with task CRUD and getCompaniesWithTasks</name>
  <files>src/lib/tasks.ts, src/lib/companies.ts</files>
  <action>
    **Extend src/lib/tasks.ts** -- add three new functions after the existing ones (do NOT remove insertDefaultTasks or getTasksByCompanyId):

    1. `createTask(task: Omit<Task, 'id' | 'created_at'>): Promise<Task>` -- Inserts a single task via `supabase.from('tasks').insert(task).select().single()`. Throws on error. Returns the created task with type assertion `as Task`.

    2. `updateTask(id: string, updates: Partial<Omit<Task, 'id' | 'created_at'>>): Promise<Task>` -- Updates a task via `supabase.from('tasks').update(updates).eq('id', id).select().single()`. Throws on error. Returns updated task.

    3. `deleteTask(id: string): Promise<void>` -- Deletes via `supabase.from('tasks').delete().eq('id', id)`. Throws on error.

    **Extend src/lib/companies.ts** -- add one new function:

    4. `getCompaniesWithTasks(): Promise<CompanyWithTasks[]>` -- Fetches all companies with their full task objects:
       - Query: `supabase.from('companies').select('*, tasks(*)').order('name', { ascending: true })`
       - Map the result to sort each company's tasks by `deadline` ascending (using `a.deadline.localeCompare(b.deadline)`)
       - Import `CompanyWithTasks` from `@/types/database`
       - Use type assertion pattern consistent with existing code: `as CompanyWithTasks[]`
       - Handle the Supabase embedded relation response: each company object will have a `tasks` array property from the `tasks(*)` select

    Important: Keep all existing functions unchanged. Only ADD new exports.
  </action>
  <verify>
    - `npx tsc --noEmit` passes with no type errors
    - Grep for all four function names in their respective files to confirm they exist
    - Existing functions (insertDefaultTasks, getTasksByCompanyId, getCompaniesWithOpenTaskCounts, etc.) still present
  </verify>
  <done>tasks.ts exports createTask, updateTask, deleteTask. companies.ts exports getCompaniesWithTasks. All existing functions preserved. No type errors.</done>
</task>

<task type="auto">
  <name>Task 3: Create gantt-utils.ts timeline utility module</name>
  <files>src/lib/gantt-utils.ts</files>
  <action>
    Create `src/lib/gantt-utils.ts` with these pure utility functions (no 'use client' directive needed -- pure functions work everywhere):

    1. `getTimelineRange(anchorDate: string, dayCount: number = 14): string[]`
       - Parse anchorDate with `parseISO(anchorDate)`
       - Get Monday of that week with `startOfWeek(anchor, { weekStartsOn: 1 })`
       - Get end date with `addDays(weekStart, dayCount - 1)`
       - Return `eachDayOfInterval({ start: weekStart, end }).map(d => format(d, 'yyyy-MM-dd'))`

    2. `getColumnIndex(dateStr: string, rangeStart: string): number`
       - Return `differenceInCalendarDays(parseISO(dateStr), parseISO(rangeStart))`

    3. `isDateInRange(date: string, start: string | null, end: string | null): boolean`
       - If `!start` return false
       - If `!end` return `date >= start` (ongoing warmup with no go-live set)
       - Otherwise return `date >= start && date <= end`

    4. `formatDayHeader(dateStr: string): { dayName: string; dayNum: string }`
       - dayName: `format(d, 'EEEEEE', { locale: nl })` -- gives "ma", "di", etc.
       - dayNum: `format(d, 'd')` -- gives "8", "15", etc.

    Imports needed: `eachDayOfInterval, startOfWeek, addDays, format, parseISO, differenceInCalendarDays` from 'date-fns', and `nl` from 'date-fns/locale/nl'.

    All dates are 'yyyy-MM-dd' strings (consistent with project convention from decision [02-04]).
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Quick manual verification: `node -e "const g = require('./src/lib/gantt-utils'); console.log(g.getTimelineRange('2026-02-08'))"` -- should return array of 14 date strings starting from Monday 2026-02-02 (or use a test file). If CommonJS import fails due to TypeScript, verify via tsc only.
  </verify>
  <done>gantt-utils.ts exports getTimelineRange, getColumnIndex, isDateInRange, formatDayHeader. All pure functions, no side effects, fully typed.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with zero errors
- src/components/ui/checkbox.tsx and src/components/ui/switch.tsx exist
- src/lib/tasks.ts has 5 exported functions (insertDefaultTasks, getTasksByCompanyId, createTask, updateTask, deleteTask)
- src/lib/companies.ts has 5 exported functions (getCompaniesWithOpenTaskCounts, getCompanyById, createCompany, updateCompany, getCompaniesWithTasks)
- src/lib/gantt-utils.ts has 4 exported functions
</verification>

<success_criteria>
- All shadcn/ui components install cleanly
- Task CRUD functions follow existing supabase patterns (type assertions, throw on error)
- getCompaniesWithTasks returns CompanyWithTasks[] with tasks sorted by deadline
- gantt-utils functions are pure, typed, and use date-fns with Monday week start
- TypeScript compilation passes
</success_criteria>

<output>
After completion, create `.planning/phases/03-gantt-chart-task-management/03-01-SUMMARY.md`
</output>
