---
phase: 03-gantt-chart-task-management
plan: 03
type: execute
wave: 3
depends_on: ["03-02"]
files_modified:
  - src/components/gantt/task-edit-dialog.tsx
  - src/components/gantt/task-create-dialog.tsx
  - src/components/gantt/company-tasks-dialog.tsx
  - src/components/gantt/gantt-page.tsx
autonomous: true

must_haves:
  truths:
    - "Clicking a task marker opens an edit dialog with editable title, urgency toggle, notes textarea, completion checkbox, save/cancel buttons, and delete with confirmation"
    - "Clicking a company name opens a dialog listing all tasks for that company sorted by deadline, each clickable to open task edit"
    - "The + Nieuwe taak button opens a create dialog with title and deadline fields, company pre-selected"
    - "Saving a task edit updates the task in the database and refreshes the Gantt display"
    - "Creating a new task inserts it in the database and the task immediately appears on the timeline"
    - "Deleting a task removes it from the database after confirmation and the marker disappears from the timeline"
    - "Only one overlay is open at a time (state machine prevents conflicts)"
  artifacts:
    - path: "src/components/gantt/task-edit-dialog.tsx"
      provides: "Task edit overlay with full CRUD controls"
      exports: ["TaskEditDialog"]
      min_lines: 50
    - path: "src/components/gantt/task-create-dialog.tsx"
      provides: "Task creation overlay with title and deadline"
      exports: ["TaskCreateDialog"]
      min_lines: 40
    - path: "src/components/gantt/company-tasks-dialog.tsx"
      provides: "Company task list overlay with clickable tasks"
      exports: ["CompanyTasksDialog"]
      min_lines: 30
  key_links:
    - from: "src/components/gantt/task-edit-dialog.tsx"
      to: "src/lib/tasks.ts"
      via: "updateTask and deleteTask calls"
      pattern: "updateTask|deleteTask"
    - from: "src/components/gantt/task-create-dialog.tsx"
      to: "src/lib/tasks.ts"
      via: "createTask call"
      pattern: "createTask"
    - from: "src/components/gantt/gantt-page.tsx"
      to: "src/components/gantt/task-edit-dialog.tsx"
      via: "overlay state machine renders TaskEditDialog"
      pattern: "overlay\\.type.*editTask"
    - from: "src/components/gantt/company-tasks-dialog.tsx"
      to: "src/components/gantt/gantt-page.tsx"
      via: "onEditTask callback transitions from companyTasks to editTask overlay"
      pattern: "setOverlay.*editTask"
---

<objective>
Build the three interactive dialog overlays for task CRUD: task editing (with urgency, completion, notes, delete), task creation (title + deadline), and company task listing. Wire all dialogs into the Gantt page's overlay state machine with data refresh after mutations.

Purpose: This completes all interactive Gantt functionality -- users can create, edit, complete, and delete tasks directly from the Gantt view. This is the final plan needed for the phase.
Output: Three dialog components wired into the existing overlay state machine, with Supabase mutations and automatic Gantt refresh.
</objective>

<execution_context>
@C:\Users\bstei\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\bstei\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-gantt-chart-task-management/03-RESEARCH.md
@.planning/phases/03-gantt-chart-task-management/03-02-SUMMARY.md
@src/components/gantt/gantt-page.tsx
@src/lib/tasks.ts
@src/lib/overdue.ts
@src/lib/dates.ts
@src/types/database.ts
@src/components/ui/dialog.tsx
@src/components/ui/checkbox.tsx
@src/components/ui/switch.tsx
@src/components/ui/input.tsx
@src/components/ui/label.tsx
@src/components/ui/textarea.tsx
@src/components/ui/button.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create task edit dialog and task create dialog</name>
  <files>src/components/gantt/task-edit-dialog.tsx, src/components/gantt/task-create-dialog.tsx</files>
  <action>
    **1. Create src/components/gantt/task-edit-dialog.tsx** -- Full task editor in a Dialog:
    - Props: `task: Task | null` (null = closed), `onClose: () => void`, `onSaved: () => void` (triggers data refresh)
    - Dialog `open` controlled by `!!task`
    - Local state initialized from task prop (use useEffect to sync when task changes):
      - `title` (string)
      - `isCompleted` (boolean)
      - `isUrgent` (boolean)
      - `notes` (string)
      - `saving` (boolean)
      - `confirmDelete` (boolean) -- for delete confirmation
    - **Form layout** (all Dutch labels):
      - "Titel" -- Input field bound to title state
      - "Afgerond" -- Checkbox with Label, checked={isCompleted}, onCheckedChange sets boolean
      - "Urgent" -- Switch with Label, checked={isUrgent}, onCheckedChange sets boolean
      - "Notities" -- Textarea bound to notes state, rows={3}
      - Show deadline as read-only info: "Deadline: {formatShortDate(task.deadline)}" in muted text
    - **Footer:**
      - Left side: Delete button (variant="destructive", size="sm") with Trash2 icon and "Verwijderen" text
        - First click sets `confirmDelete = true` and changes button text to "Bevestig verwijderen"
        - Second click (when confirmDelete is true): calls `deleteTask(task.id)`, then `onSaved()`, then `onClose()`
        - Reset confirmDelete to false when dialog opens or on cancel
      - Right side: "Annuleren" button (variant="outline") calling onClose, "Opslaan" button calling handleSave
    - **handleSave:** Set saving=true, call `updateTask(task.id, { title, is_completed: isCompleted, is_urgent: isUrgent, notes: notes || null })`, then `onSaved()`, then `onClose()`. Wrap in try/catch, set saving=false in finally.
    - **handleDelete:** Call `deleteTask(task.id)`, then `onSaved()`, then `onClose()`.
    - Imports: Dialog/DialogContent/DialogHeader/DialogTitle/DialogFooter from ui/dialog, Button, Input, Label, Textarea, Checkbox, Switch from ui/*, updateTask/deleteTask from lib/tasks, formatShortDate from lib/dates, Trash2 from lucide-react
    - Use 'use client' directive

    **2. Create src/components/gantt/task-create-dialog.tsx** -- New task creator in a Dialog:
    - Props: `companyId: string | null` (null = closed), `onClose: () => void`, `onCreated: () => void`
    - Dialog `open` controlled by `!!companyId`
    - Local state:
      - `title` (string, default empty)
      - `deadline` (string, default empty -- 'yyyy-MM-dd' format)
      - `saving` (boolean)
    - Reset title and deadline when dialog opens (useEffect on companyId change)
    - **Form layout** (Dutch labels):
      - DialogTitle: "Nieuwe taak"
      - "Titel" -- Input field, required
      - "Deadline" -- Input field with `type="date"` for native date picker
    - **Footer:**
      - "Annuleren" (variant="outline") calling onClose
      - "Aanmaken" (primary) calling handleCreate, disabled when title is empty or deadline is empty or saving
    - **handleCreate:** Set saving=true, call `createTask({ company_id: companyId!, title, deadline, is_completed: false, is_urgent: false, is_date_editable: true, notes: null })`, then `onCreated()`, then `onClose()`. Try/catch with saving=false in finally.
    - Imports: Dialog components, Button, Input, Label from ui/*, createTask from lib/tasks
    - Use 'use client' directive
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Both files export their components cleanly
  </verify>
  <done>TaskEditDialog supports editing title, urgency, completion, notes, and deleting with confirmation. TaskCreateDialog creates a task with title and deadline. Both call Supabase via data access layer and trigger refresh callback.</done>
</task>

<task type="auto">
  <name>Task 2: Create company tasks dialog and wire all dialogs into Gantt page</name>
  <files>src/components/gantt/company-tasks-dialog.tsx, src/components/gantt/gantt-page.tsx</files>
  <action>
    **1. Create src/components/gantt/company-tasks-dialog.tsx** -- Company task list overlay:
    - Props: `company: CompanyWithTasks | null` (null = closed), `today: string`, `onClose: () => void`, `onEditTask: (task: Task) => void`
    - Dialog `open` controlled by `!!company`
    - DialogTitle: `Taken - {company?.name}`
    - Body: Scrollable list (`max-h-96 overflow-y-auto space-y-2`) of all company tasks sorted by deadline ascending
    - Each task renders as a clickable button (full width, text-left) that calls `onEditTask(task)`:
      - Left side: colored dot (size-2 rounded-full) matching task-marker colors (green=completed, orange=urgent, red=pending), then task title (with line-through + text-muted-foreground if completed)
      - Right side: overdue badge if applicable (using computeOverdue), then deadline formatted with `formatShortDate`
      - Row styling: `p-3 rounded-lg border hover:bg-accent transition-colors flex items-center justify-between`
    - If company has no tasks, show "Geen taken" message in muted text
    - Imports: Dialog components, computeOverdue from lib/overdue, formatShortDate from lib/dates, cn from lib/utils
    - Use 'use client' directive

    **2. Wire all three dialogs into src/components/gantt/gantt-page.tsx:**
    - Import TaskEditDialog, TaskCreateDialog, CompanyTasksDialog
    - At the bottom of the GanttPage return, AFTER the GanttTimeline, render all three dialogs based on overlay state:
      ```
      <TaskEditDialog
        task={overlay.type === 'editTask' ? overlay.task : null}
        onClose={() => setOverlay({ type: 'none' })}
        onSaved={refreshData}
      />
      <TaskCreateDialog
        companyId={overlay.type === 'createTask' ? overlay.companyId : null}
        onClose={() => setOverlay({ type: 'none' })}
        onCreated={refreshData}
      />
      <CompanyTasksDialog
        company={overlay.type === 'companyTasks' ? overlay.company : null}
        today={today}
        onClose={() => setOverlay({ type: 'none' })}
        onEditTask={(task) => setOverlay({ type: 'editTask', task })}
      />
      ```
    - The overlay state machine ensures only one dialog is open at a time. When company-tasks-dialog's onEditTask fires, it transitions directly from companyTasks to editTask overlay (the company dialog closes, the edit dialog opens).
    - The `refreshData` callback (already defined in Plan 02) re-fetches all companies with tasks and updates the state, causing the Gantt grid to re-render with the latest data.
    - Ensure the onClose handler for Dialog's onOpenChange also fires: pass `onOpenChange={(open) => { if (!open) onClose() }}` or handle it within each dialog component.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `npx next build` succeeds
    - Visit /gantt:
      1. Click a task marker -> edit dialog opens with task data -> change title -> save -> marker updates
      2. Click Verwijderen -> shows "Bevestig verwijderen" -> click again -> task removed from grid
      3. Click company name -> task list dialog opens -> click a task -> transitions to edit dialog
      4. Click "+" on a company row -> create dialog opens with that company pre-selected -> enter title + date -> Aanmaken -> new marker appears on timeline
  </verify>
  <done>All three dialog overlays work: task edit with save/delete, task create with title/deadline, company task list with click-to-edit. Overlay state machine prevents multiple dialogs. Data refreshes after every mutation. All GANT-05, GANT-06, GANT-07 requirements met.</done>
</task>

</tasks>

<verification>
- Clicking task marker opens edit dialog with correct task data pre-filled
- Edit dialog has: editable title, urgency Switch, notes Textarea, completion Checkbox, Opslaan/Annuleren/Verwijderen buttons
- Delete requires two clicks (confirmation pattern)
- Saving edits persists to database and Gantt grid refreshes
- Clicking company name opens task list dialog sorted by deadline
- Clicking a task in the list transitions to edit dialog (company dialog closes)
- "+" button opens create dialog with company pre-selected
- Creating a task with title + deadline adds it to database and shows on timeline immediately
- Only one dialog open at a time
- `npx next build` succeeds with no errors
</verification>

<success_criteria>
- GANT-05: Task edit overlay with all required fields and actions
- GANT-06: Company tasks overlay with sorted list, clickable to edit
- GANT-07: Task creation with title + deadline, company pre-selected
- All task mutations (create, update, delete) persist to Supabase
- Gantt grid refreshes after every mutation
- Overlay state machine prevents dialog conflicts
- All Dutch labels used throughout (Titel, Afgerond, Urgent, Notities, Opslaan, Annuleren, Verwijderen, Nieuwe taak, Aanmaken, Taken)
</success_criteria>

<output>
After completion, create `.planning/phases/03-gantt-chart-task-management/03-03-SUMMARY.md`
</output>
