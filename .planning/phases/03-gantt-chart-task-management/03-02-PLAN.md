---
phase: 03-gantt-chart-task-management
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/app/gantt/page.tsx
  - src/components/gantt/gantt-page.tsx
  - src/components/gantt/gantt-header.tsx
  - src/components/gantt/gantt-timeline.tsx
  - src/components/gantt/gantt-company-row.tsx
  - src/components/gantt/gantt-day-header.tsx
  - src/components/gantt/task-marker.tsx
autonomous: true

must_haves:
  truths:
    - "The Gantt page shows a left sidebar with company names and a horizontally scrollable timeline grid with day columns"
    - "Company warmup bars appear as light blue background spanning warmup_start_date to go_live_date across day cells"
    - "Today's column is visually highlighted with a distinct background color"
    - "Tasks appear as colored markers at their effective deadline position (overdue tasks at today's column)"
    - "Overdue tasks show a -N delay badge (red pill, white text)"
    - "Arrow buttons navigate the timeline by 7 days and Vandaag button jumps to current week"
    - "Default view shows 14 days starting from Monday of the current week"
    - "Urgent tasks show orange marker color, pending red, completed green"
  artifacts:
    - path: "src/app/gantt/page.tsx"
      provides: "Server component wrapper for Gantt page"
      contains: "force-dynamic"
    - path: "src/components/gantt/gantt-page.tsx"
      provides: "Main client component with data fetching, navigation state, and overlay state machine"
      min_lines: 60
    - path: "src/components/gantt/gantt-header.tsx"
      provides: "Title bar with prev/next arrows and Vandaag button"
      exports: ["GanttHeader"]
    - path: "src/components/gantt/gantt-timeline.tsx"
      provides: "CSS Grid container with sticky sidebar and scrollable day columns"
      exports: ["GanttTimeline"]
    - path: "src/components/gantt/gantt-company-row.tsx"
      provides: "Company row with sidebar cell, warmup bar cells, and task markers"
      exports: ["GanttCompanyRow"]
    - path: "src/components/gantt/gantt-day-header.tsx"
      provides: "Day column header with Dutch day abbreviation and date number"
      exports: ["GanttDayHeader"]
    - path: "src/components/gantt/task-marker.tsx"
      provides: "Colored dot for task with overdue badge"
      exports: ["TaskMarker"]
  key_links:
    - from: "src/components/gantt/gantt-page.tsx"
      to: "src/lib/companies.ts"
      via: "getCompaniesWithTasks fetch on mount"
      pattern: "getCompaniesWithTasks"
    - from: "src/components/gantt/gantt-page.tsx"
      to: "src/lib/gantt-utils.ts"
      via: "getTimelineRange for day column generation"
      pattern: "getTimelineRange"
    - from: "src/components/gantt/gantt-company-row.tsx"
      to: "src/lib/overdue.ts"
      via: "computeOverdue for effective deadline placement"
      pattern: "computeOverdue"
    - from: "src/components/gantt/task-marker.tsx"
      to: "src/lib/overdue.ts"
      via: "computeOverdue for overdue badge"
      pattern: "computeOverdue"
    - from: "src/components/gantt/gantt-page.tsx"
      to: "src/lib/today-provider.tsx"
      via: "useToday hook for current date"
      pattern: "useToday"
---

<objective>
Build the complete Gantt chart visual rendering: the CSS Grid layout with sticky sidebar, company rows with warmup bars and task markers, day column headers, timeline navigation, and overdue badges.

Purpose: This is the core visual component of Phase 3 -- users see all company warmup timelines and task positions at a glance. Without this, there is nothing to interact with.
Output: A fully rendered, scrollable, navigable Gantt chart showing companies, warmup bars, task markers with status colors, overdue badges, and today highlighting.
</objective>

<execution_context>
@C:\Users\bstei\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\bstei\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-gantt-chart-task-management/03-RESEARCH.md
@.planning/phases/03-gantt-chart-task-management/03-01-SUMMARY.md
@src/lib/gantt-utils.ts
@src/lib/overdue.ts
@src/lib/companies.ts
@src/lib/tasks.ts
@src/lib/today-provider.tsx
@src/lib/dates.ts
@src/types/database.ts
@src/components/ui/button.tsx
@src/components/ui/badge.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Gantt page shell, header, and day header components</name>
  <files>src/app/gantt/page.tsx, src/components/gantt/gantt-page.tsx, src/components/gantt/gantt-header.tsx, src/components/gantt/gantt-day-header.tsx</files>
  <action>
    **1. Replace src/app/gantt/page.tsx** -- Convert from placeholder to server component wrapper:
    - Add `export const dynamic = 'force-dynamic'` (same pattern as /bedrijven page, prevents SSR prerender failure)
    - Import and render `GanttPage` from `@/components/gantt/gantt-page`
    - Wrap in `<main className="p-6">` for consistent page padding

    **2. Create src/components/gantt/gantt-page.tsx** -- The main client component ('use client'):
    - State: `anchorDate` (string, initialized to `useToday()`), `companies` (CompanyWithTasks[]), `loading` (boolean), `overlay` (OverlayState discriminated union)
    - The OverlayState type: `{ type: 'none' } | { type: 'editTask'; task: Task } | { type: 'createTask'; companyId: string } | { type: 'companyTasks'; company: CompanyWithTasks }`
    - On mount: call `getCompaniesWithTasks()`, set companies state, set loading false. Wrap in useEffect with async IIFE.
    - Create `refreshData` async callback that re-fetches companies (will be passed to dialogs in Plan 03)
    - `days` computed via `useMemo(() => getTimelineRange(anchorDate, 14), [anchorDate])`
    - `navigateWeek(direction: 'prev' | 'next')`: shifts anchorDate by +/-7 days using addWeeks/subWeeks from date-fns, formats back to 'yyyy-MM-dd'
    - `goToToday()`: sets anchorDate back to today
    - Render: GanttHeader (with navigation props), GanttTimeline (with companies, days, today, overlay setter callbacks). Show a "Laden..." text while loading.
    - Export overlay state setter functions: `onTaskClick(task)`, `onCompanyClick(company)`, `onAddTask(companyId)`, `onCloseOverlay()` -- these set the overlay state. The actual Dialog rendering will be added in Plan 03; for now just define the state and callbacks.
    - Import `useToday` from '@/lib/today-provider', `getCompaniesWithTasks` from '@/lib/companies', `getTimelineRange` from '@/lib/gantt-utils', `addWeeks, subWeeks, format, parseISO` from 'date-fns'

    **3. Create src/components/gantt/gantt-header.tsx** -- Navigation bar:
    - Props: `days: string[]` (to show range label), `onPrev: () => void`, `onNext: () => void`, `onToday: () => void`
    - Render: Title "Gantt" as h1, then a row with:
      - Button with ChevronLeft icon (variant="outline", size="icon") calling onPrev
      - A label showing the date range: first day formatted as "d MMM" + " - " + last day formatted as "d MMM yyyy" using date-fns format with nl locale
      - Button with ChevronRight icon calling onNext
      - Button "Vandaag" (variant="outline") calling onToday
    - Use flex layout with items-center, gap-2

    **4. Create src/components/gantt/gantt-day-header.tsx** -- Single day column header:
    - Props: `dateStr: string`, `isToday: boolean`
    - Use `formatDayHeader(dateStr)` from gantt-utils to get dayName and dayNum
    - Render stacked vertically: dayName on top (text-[10px] text-muted-foreground uppercase), dayNum below (text-sm font-medium)
    - Center content. Apply today highlight: `bg-blue-50 dark:bg-blue-950/30` when isToday
    - Add `border-b border-r` for grid lines, `p-1` for padding, `h-12` for fixed height
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Visit /gantt page -- should show "Gantt" title, navigation arrows, "Vandaag" button, "Laden..." text (then timeline once data loads)
  </verify>
  <done>Gantt page renders with header showing navigation controls and date range label. Page uses force-dynamic. GanttPage has overlay state machine and navigation logic. GanttDayHeader renders Dutch day abbreviation and number.</done>
</task>

<task type="auto">
  <name>Task 2: Create timeline grid, company row, and task marker components</name>
  <files>src/components/gantt/gantt-timeline.tsx, src/components/gantt/gantt-company-row.tsx, src/components/gantt/task-marker.tsx</files>
  <action>
    **1. Create src/components/gantt/gantt-timeline.tsx** -- The CSS Grid scrollable container:
    - Props: `companies: CompanyWithTasks[]`, `days: string[]`, `today: string`, `onTaskClick: (task: Task) => void`, `onCompanyClick: (company: CompanyWithTasks) => void`, `onAddTask: (companyId: string) => void`
    - Render an outer div with `overflow-x-auto border rounded-lg` and a `ref` for the scroll container
    - Inside, a div with `display: grid` via inline style: `gridTemplateColumns: \`200px repeat(\${days.length}, 48px)\``
    - **Header row:**
      - First cell (sidebar header): `className="sticky left-0 z-20 bg-background border-b border-r p-2 font-medium text-sm"`, content: "Bedrijf"
      - Then map `days` to `<GanttDayHeader>` components, passing `isToday={day === today}`
    - **Company rows:** Map companies to `<GanttCompanyRow>` components, passing all required props
    - If no companies: show an empty state message
    - **Scroll reset on days change:** Use a `useEffect` that resets `scrollRef.current.scrollLeft = 0` when `days` changes (when navigating weeks). Use useRef for the scroll container.

    **2. Create src/components/gantt/gantt-company-row.tsx** -- Single company row (renders as a React Fragment with 1+N cells):
    - Props: `company: CompanyWithTasks`, `days: string[]`, `today: string`, `onTaskClick: (task: Task) => void`, `onCompanyClick: (company: CompanyWithTasks) => void`, `onAddTask: (companyId: string) => void`
    - **Sidebar cell** (sticky): `className="sticky left-0 z-10 bg-background border-b border-r p-2 flex items-center justify-between gap-1"`
      - Company name as a button with `text-sm font-medium hover:underline truncate text-left` that calls `onCompanyClick(company)` on click
      - "+" button (Plus icon from lucide-react, size-3.5) calling `onAddTask(company.id)` with `text-muted-foreground hover:text-foreground` styling
    - **Day cells:** Map over `days`. For each day:
      - Determine if day is within warmup range using `isDateInRange(day, company.warmup_start_date, company.go_live_date)` from gantt-utils
      - Determine if it's today: `day === today`
      - Filter tasks for this cell: tasks whose `computeOverdue(task.deadline, today, task.is_completed).effectiveDeadline === day`
      - Cell className: `relative border-b border-r h-12 flex items-center justify-center gap-0.5 flex-wrap`
        - Add `bg-blue-100/40 dark:bg-blue-900/20` when isInWarmup (warmup bar effect)
        - Add `bg-blue-50 dark:bg-blue-950/30` when isToday (but warmup takes visual priority if both -- use cn to combine, warmup color will blend with today highlight via opacity)
      - Render `<TaskMarker>` for each task in that cell
    - Import `computeOverdue` from '@/lib/overdue', `isDateInRange` from '@/lib/gantt-utils', `cn` from '@/lib/utils'

    **3. Create src/components/gantt/task-marker.tsx** -- Colored dot with overdue badge:
    - Props: `task: Task`, `today: string`, `onClick: (task: Task) => void`
    - Compute overdue: `const overdue = computeOverdue(task.deadline, today, task.is_completed)`
    - Render a button with `className="relative group"` and `title={task.title}` for native tooltip
    - Inside: a div for the marker dot: `size-3.5 rounded-full border-2 transition-transform group-hover:scale-125`
      - Colors (from UIST-04):
        - Completed: `bg-green-500 border-green-600`
        - Urgent (not completed): `bg-orange-500 border-orange-600`
        - Pending (not completed, not urgent): `bg-red-500 border-red-600`
    - Overdue badge (from UIST-05): if `overdue.isOverdue`, render `<span>` with `absolute -top-2 -right-3 bg-red-600 text-white text-[9px] font-bold px-1 rounded-full leading-tight whitespace-nowrap` showing `-{overdue.daysOverdue}`
    - onClick calls `onClick(task)`
    - Import `computeOverdue` from '@/lib/overdue', `cn` from '@/lib/utils'

    **Wire everything together:** In gantt-page.tsx, replace the "Laden..." placeholder with `<GanttTimeline>` once loading is false. Pass companies, days, today, and the onTaskClick/onCompanyClick/onAddTask callbacks.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `npx next build` succeeds
    - Visit /gantt -- see company names in left sidebar, day columns with headers, warmup bars as blue backgrounds, task dots colored by status, overdue badges showing -N, today column highlighted, navigation arrows work
  </verify>
  <done>Full Gantt grid renders with sticky sidebar, scrollable day columns, warmup bar backgrounds, colored task markers with overdue badges, today highlighting, and week navigation. Clicking tasks/companies/+ buttons logs to console or triggers overlay state (no dialogs yet).</done>
</task>

</tasks>

<verification>
- /gantt page renders without errors
- Company names appear in sticky left sidebar that stays fixed while scrolling horizontally
- Day column headers show Dutch abbreviated day names (ma, di, wo, do, vr, za, zo) and day numbers
- Warmup bars appear as light blue background across the correct day cells
- Today's column has a distinct highlighted background
- Task markers appear as colored dots: red=pending, green=completed, orange=urgent
- Overdue tasks show at today's column position with -N red pill badge
- Arrow navigation shifts the view by 7 days
- Vandaag button returns to current week view
- `npx next build` succeeds
</verification>

<success_criteria>
- Gantt chart is visually complete: sidebar + scrollable grid + warmup bars + task markers + overdue badges
- All GANT-01, GANT-02, GANT-03, GANT-04, GANT-08, GANT-09 requirements are rendered (not yet interactive beyond navigation)
- UIST-04 and UIST-05 color/badge requirements are met
- No console errors in browser
</success_criteria>

<output>
After completion, create `.planning/phases/03-gantt-chart-task-management/03-02-SUMMARY.md`
</output>
