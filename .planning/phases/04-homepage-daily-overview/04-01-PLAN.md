---
phase: 04-homepage-daily-overview
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/lib/homepage.ts
  - src/lib/__tests__/homepage.test.ts
autonomous: true

must_haves:
  truths:
    - "getTodayTasksWithCompany returns tasks joined with company names from Supabase"
    - "filterTodayTasks returns only tasks whose effective deadline equals today, including completed tasks with original deadline = today"
    - "sortTodayTasks sorts incomplete above completed, urgent first, most overdue first, then alphabetical by title"
  artifacts:
    - path: "src/lib/homepage.ts"
      provides: "Data fetching, filtering, sorting for homepage"
      exports: ["TodayTask", "TaskWithCompany", "getTodayTasksWithCompany", "filterTodayTasks", "sortTodayTasks"]
    - path: "src/lib/__tests__/homepage.test.ts"
      provides: "Unit tests for sort and filter logic"
      contains: "sortTodayTasks"
  key_links:
    - from: "src/lib/homepage.ts"
      to: "src/lib/overdue.ts"
      via: "computeOverdue import"
      pattern: "import.*computeOverdue.*from.*overdue"
    - from: "src/lib/homepage.ts"
      to: "src/lib/supabase.ts"
      via: "supabase client import"
      pattern: "import.*supabase.*from.*supabase"
---

<objective>
Create the homepage data layer: Supabase query for tasks with company names, client-side filter for today's effective deadline, and multi-criteria sort function. TDD the sort logic.

Purpose: The homepage needs tasks joined with company names, filtered to "today's tasks" (overdue rolled forward + completed with deadline = today), and sorted by priority. This is the data foundation that all homepage UI components consume.
Output: `src/lib/homepage.ts` with types, fetch, filter, sort functions + `src/lib/__tests__/homepage.test.ts` with sort/filter unit tests.
</objective>

<execution_context>
@C:\Users\bstei\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\bstei\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-homepage-daily-overview/04-RESEARCH.md

@src/lib/overdue.ts
@src/lib/supabase.ts
@src/lib/companies.ts
@src/types/database.ts
@src/lib/__tests__/overdue.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: RED -- Write failing tests for sortTodayTasks and filterTodayTasks</name>
  <files>src/lib/__tests__/homepage.test.ts</files>
  <action>
Create test file with Vitest (following overdue.test.ts pattern).

**sortTodayTasks tests (at minimum):**
1. Incomplete tasks sort above completed tasks
2. Urgent incomplete tasks sort above non-urgent incomplete tasks
3. Among non-urgent incomplete tasks, most overdue sorts first (higher daysOverdue = higher priority)
4. Tasks with same urgency and overdue days sort alphabetically by title (Dutch locale)
5. Empty array returns empty array

**filterTodayTasks tests (at minimum):**
1. Incomplete task with deadline in the past (overdue) -- effective deadline = today -- INCLUDED
2. Incomplete task with deadline = today -- INCLUDED
3. Incomplete task with deadline in the future -- EXCLUDED (effective deadline is future, not today)
4. Completed task with deadline = today -- INCLUDED (shows with strikethrough)
5. Completed task with deadline in the past -- EXCLUDED (effective deadline = past deadline since completed tasks are not rolled forward)

Use `computeOverdue` from overdue.ts to construct TodayTask test fixtures. The `today` parameter for filter tests should be a fixed string like '2025-02-10'.

Build TodayTask fixtures with minimal Task objects (only fields used by sort/filter: id, title, deadline, is_completed, is_urgent, company_id, is_date_editable, notes, created_at).

Run `npx vitest run src/lib/__tests__/homepage.test.ts` -- tests MUST fail (functions do not exist yet).
  </action>
  <verify>npx vitest run src/lib/__tests__/homepage.test.ts -- should show failures (module not found or function not defined)</verify>
  <done>Test file exists with 5+ sort tests and 5+ filter tests, all failing</done>
</task>

<task type="auto">
  <name>Task 2: GREEN -- Implement homepage data layer to pass all tests</name>
  <files>src/lib/homepage.ts</files>
  <action>
Create `src/lib/homepage.ts` as a pure module (no 'use client' -- consistent with dates.ts and gantt-utils.ts patterns).

**Types:**
```typescript
export interface TaskWithCompany extends Task {
  company_name: string
}

export interface TodayTask {
  task: TaskWithCompany
  companyName: string
  overdue: OverdueResult
}
```

**getTodayTasksWithCompany(today: string): Promise&lt;TaskWithCompany[]&gt;**
- Query Supabase: `supabase.from('tasks').select('*, companies!inner(name)')` with `.lte('deadline', today)` to fetch tasks with deadline <= today (this captures all overdue + today tasks)
- Also need completed tasks with deadline = today, but the `lte` filter already includes those
- Map result to TaskWithCompany using the same `unknown` cast pattern from companies.ts (line 19-22)
- Cast companies embedded relation: `(row as unknown as Task & { companies: { name: string } })`

**filterTodayTasks(tasks: TaskWithCompany[], today: string): TodayTask[]**
- For each task, compute `computeOverdue(task.deadline, today, task.is_completed)`
- Include task if: `overdue.effectiveDeadline === today` (handles overdue rolled to today)
- OR: `task.is_completed && task.deadline === today` (completed tasks due today)
- Return array of TodayTask objects

**sortTodayTasks(tasks: TodayTask[]): TodayTask[]**
- Return a NEW sorted array (do not mutate input)
- Sort order (4 criteria):
  1. Incomplete above completed (`is_completed ? 1 : -1`)
  2. Urgent first within same completion status (`is_urgent ? -1 : 1`)
  3. Most overdue first (`b.overdue.daysOverdue - a.overdue.daysOverdue`)
  4. Alphabetical by title (`a.task.title.localeCompare(b.task.title, 'nl')`)

Run `npx vitest run src/lib/__tests__/homepage.test.ts` -- all tests MUST pass.
  </action>
  <verify>npx vitest run src/lib/__tests__/homepage.test.ts -- all tests pass</verify>
  <done>homepage.ts exports TodayTask, TaskWithCompany, getTodayTasksWithCompany, filterTodayTasks, sortTodayTasks. All tests green.</done>
</task>

</tasks>

<verification>
- `npx vitest run src/lib/__tests__/homepage.test.ts` passes all tests
- `npx tsc --noEmit` compiles without errors
- homepage.ts has no 'use client' directive (pure module)
- Sort function produces stable, deterministic ordering
</verification>

<success_criteria>
- sortTodayTasks correctly implements 4-tier priority: incomplete > completed, urgent > non-urgent, most overdue > least overdue, alphabetical
- filterTodayTasks includes overdue tasks (effective deadline = today) AND completed tasks with deadline = today
- getTodayTasksWithCompany fetches tasks joined with company names from Supabase
- All edge cases covered by tests (empty array, all completed, all urgent, mixed)
</success_criteria>

<output>
After completion, create `.planning/phases/04-homepage-daily-overview/04-01-SUMMARY.md`
</output>
