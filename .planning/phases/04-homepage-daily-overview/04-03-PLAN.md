---
phase: 04-homepage-daily-overview
plan: 03
type: execute
wave: 2
depends_on: ["04-01", "04-02"]
files_modified:
  - src/components/homepage/today-task-list.tsx
  - src/components/homepage/homepage.tsx
  - src/app/page.tsx
autonomous: true

must_haves:
  truths:
    - "Homepage at / shows Vandaag header, progress donut, and sorted task list on page load"
    - "Task list displays all tasks with effective deadline = today, including overdue tasks rolled forward and completed tasks due today"
    - "Clicking a task row opens TaskEditDialog with the task data, and saving/closing refreshes the list"
    - "Completed tasks appear below incomplete tasks with strikethrough and green checkmark"
  artifacts:
    - path: "src/components/homepage/homepage.tsx"
      provides: "Client orchestrator with data fetch, overlay state machine, composition"
      contains: "OverlayState"
    - path: "src/components/homepage/today-task-list.tsx"
      provides: "Task list rendering with sort applied"
      contains: "TodayTaskRow"
    - path: "src/app/page.tsx"
      provides: "Homepage route (server component shell)"
      contains: "Homepage"
  key_links:
    - from: "src/components/homepage/homepage.tsx"
      to: "src/lib/homepage.ts"
      via: "getTodayTasksWithCompany + filterTodayTasks + sortTodayTasks imports"
      pattern: "import.*from.*lib/homepage"
    - from: "src/components/homepage/homepage.tsx"
      to: "src/components/gantt/task-edit-dialog.tsx"
      via: "TaskEditDialog import for overlay"
      pattern: "import.*TaskEditDialog.*from.*gantt/task-edit-dialog"
    - from: "src/components/homepage/homepage.tsx"
      to: "src/lib/today-provider.tsx"
      via: "useToday for reactive date"
      pattern: "import.*useToday.*from.*today-provider"
    - from: "src/components/homepage/today-task-list.tsx"
      to: "src/components/homepage/today-task-row.tsx"
      via: "TodayTaskRow rendering in map"
      pattern: "TodayTaskRow"
    - from: "src/app/page.tsx"
      to: "src/components/homepage/homepage.tsx"
      via: "Homepage import in server component"
      pattern: "import.*Homepage.*from.*components/homepage/homepage"
---

<objective>
Assemble the homepage: wire the data layer (Plan 01) with the UI components (Plan 02) into a working page with task list, overlay state machine, and data refresh.

Purpose: This plan connects all the pieces into the final homepage. The data flows from Supabase through getTodayTasksWithCompany -> filterTodayTasks -> sortTodayTasks -> TodayTaskList -> TodayTaskRow, with TaskEditDialog wired via the overlay state machine for HOME-07.
Output: Working homepage at `/` replacing the current placeholder, with all HOME-01 through HOME-07 requirements satisfied.
</objective>

<execution_context>
@C:\Users\bstei\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\bstei\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-homepage-daily-overview/04-RESEARCH.md
@.planning/phases/04-homepage-daily-overview/04-01-SUMMARY.md
@.planning/phases/04-homepage-daily-overview/04-02-SUMMARY.md

@src/components/gantt/gantt-page.tsx
@src/components/gantt/task-edit-dialog.tsx
@src/lib/homepage.ts
@src/components/homepage/daily-header.tsx
@src/components/homepage/progress-donut.tsx
@src/components/homepage/today-task-row.tsx
@src/app/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TodayTaskList and Homepage client orchestrator</name>
  <files>
    src/components/homepage/today-task-list.tsx
    src/components/homepage/homepage.tsx
  </files>
  <action>
**TodayTaskList (`src/components/homepage/today-task-list.tsx`):**
- 'use client' directive
- Import TodayTaskRow from `@/components/homepage/today-task-row`
- Import type TodayTask from `@/lib/homepage`
- Props: `{ tasks: TodayTask[]; onTaskClick: (task: Task) => void }`
- Render a list of TodayTaskRow components, mapping TodayTask props to TodayTaskRow props
- Handle empty state: show "Geen taken voor vandaag" in muted text when tasks array is empty
- Use `task.task.id` as React key
- Requirements covered: HOME-03, HOME-06 (sort is applied by parent)

**Homepage (`src/components/homepage/homepage.tsx`):**
- 'use client' directive
- This is the main client orchestrator -- mirrors GanttPage pattern EXACTLY:
  - State: `tasks` (TodayTask[]), `loading` (boolean), `overlay` (OverlayState)
  - OverlayState type: `{ type: 'none' } | { type: 'editTask'; task: Task }` (simplified from Gantt -- homepage only needs editTask, no createTask or companyTasks)
  - `useToday()` for reactive today
  - `useEffect` on mount + when `today` changes: call `loadData()` which does:
    1. `getTodayTasksWithCompany(today)` to fetch from Supabase
    2. `filterTodayTasks(rawTasks, today)` to get today's tasks
    3. `sortTodayTasks(filtered)` to apply sort order
    4. `setTasks(sorted)`
  - `refreshData` callback (same pattern as GanttPage): re-runs loadData
  - `onTaskClick` callback: `setOverlay({ type: 'editTask', task })` -- receives the Task object
  - `onCloseOverlay` callback: `setOverlay({ type: 'none' })`

- Layout (JSX):
  - Outer div with `space-y-6`
  - Top section: flex row with DailyHeader on the left and ProgressDonut on the right
    - ProgressDonut completed = count of tasks where `task.task.is_completed === true`
    - ProgressDonut total = tasks.length
  - Task list section: TodayTaskList with tasks and onTaskClick
  - TaskEditDialog: `task={overlay.type === 'editTask' ? overlay.task : null}` / `onClose={onCloseOverlay}` / `onSaved={refreshData}`

- Loading state: show "Laden..." in muted text (same as GanttPage)
- When `today` changes (midnight rollover), data automatically re-fetches due to useEffect dependency

- IMPORTANT: The `onTaskClick` receives a `Task` (from TodayTask.task) not a `TaskWithCompany`. The TaskEditDialog expects `Task | null`. Pass the underlying Task object.

- Requirements covered: HOME-07 (TaskEditDialog reuse), data refresh after edit
  </action>
  <verify>npx tsc --noEmit -- compiles without type errors</verify>
  <done>Homepage component fetches, filters, sorts tasks. TodayTaskList renders sorted rows. TaskEditDialog opens on row click and refreshes data on save.</done>
</task>

<task type="auto">
  <name>Task 2: Replace placeholder page.tsx with Homepage route</name>
  <files>src/app/page.tsx</files>
  <action>
Replace the current placeholder `src/app/page.tsx` (which shows "Dagoverzicht wordt hier gebouwd in Fase 4") with the actual homepage.

Follow the established pattern from `/gantt/page.tsx` and `/bedrijven/page.tsx`:
- Server component (NO 'use client')
- `export const dynamic = 'force-dynamic'` (same as bedrijven page -- prevents SSR prerender failure when Supabase env vars missing at build time)
- Import Homepage from `@/components/homepage/homepage`
- Render: `<main className="p-6"><Homepage /></main>` (matches the existing padding pattern)

This is intentionally minimal -- the server component is just a shell. All logic lives in the client Homepage component.
  </action>
  <verify>npx tsc --noEmit && npx next build -- builds without errors (or at minimum tsc passes)</verify>
  <done>Homepage route at / renders the Homepage client component. Placeholder text is gone. force-dynamic prevents build errors.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` compiles without errors
- `npx vitest run` -- all existing tests still pass (no regressions)
- Homepage at / shows: "Vandaag" header with Dutch date, progress donut, task list
- Clicking a task row opens TaskEditDialog
- After editing/completing a task in the dialog, the list refreshes
- Completed tasks show strikethrough + green check, below incomplete tasks
- Overdue tasks show red "-N" badge
- Empty state shows "Geen taken voor vandaag"
</verification>

<success_criteria>
- HOME-01: "Vandaag" header with Dutch-formatted date visible on homepage
- HOME-02: Progress donut shows completed/total ratio with color gradient and center counter
- HOME-03: Task list shows all tasks with effective deadline = today (including overdue rolled forward)
- HOME-04: Each task shows company name, title, and red overdue badge (-1, -2) when applicable
- HOME-05: Completed tasks have strikethrough and green checkmark
- HOME-06: Tasks sorted: incomplete above completed, urgent first, most overdue first, then alphabetical
- HOME-07: Clicking a task opens the same TaskEditDialog as Gantt view, edits without leaving homepage
</success_criteria>

<output>
After completion, create `.planning/phases/04-homepage-daily-overview/04-03-SUMMARY.md`
</output>
