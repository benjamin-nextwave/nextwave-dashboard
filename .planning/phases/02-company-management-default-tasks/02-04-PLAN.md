---
phase: 02-company-management-default-tasks
plan: 04
type: auto
wave: 2
depends_on: ["02-02"]
files_modified:
  - src/app/bedrijven/[id]/page.tsx
  - src/hooks/use-auto-save.ts
  - src/components/companies/company-detail/company-detail-page.tsx
  - src/components/companies/company-detail/save-indicator.tsx
  - src/components/companies/company-detail/personality-selector.tsx
  - src/components/companies/company-detail/section-basisgegevens.tsx
  - src/components/companies/company-detail/section-klantprofiel.tsx
  - src/components/companies/company-detail/section-mailvarianten.tsx
  - src/components/companies/company-detail/section-feedback.tsx
autonomous: true

must_haves:
  truths:
    - "Company detail page loads company data by ID and displays it"
    - "Basisgegevens section shows name, warmup start date, go-live date, email, phone"
    - "Klantprofiel section shows client notes textarea and 1-5 personality selector"
    - "Mailvarianten section shows 3 large text blocks side by side"
    - "Feedback & Planning section shows feedback, wensen, extra notes textareas"
    - "Fields auto-save on blur with visible status indicator"
    - "Manual save button saves all current field values"
    - "Back button navigates to /bedrijven"
  artifacts:
    - path: "src/app/bedrijven/[id]/page.tsx"
      provides: "Dynamic route that unwraps params and renders CompanyDetailPage"
      min_lines: 8
    - path: "src/hooks/use-auto-save.ts"
      provides: "useAutoSave hook with save status state"
      exports: ["useAutoSave"]
    - path: "src/components/companies/company-detail/company-detail-page.tsx"
      provides: "Main detail page orchestrator with data loading, auto-save, manual save"
      min_lines: 80
    - path: "src/components/companies/company-detail/save-indicator.tsx"
      provides: "Visual save status display (Opslaan.../Opgeslagen/Fout)"
      exports: ["SaveIndicator"]
    - path: "src/components/companies/company-detail/personality-selector.tsx"
      provides: "1-5 clickable circle selector"
      exports: ["PersonalitySelector"]
    - path: "src/components/companies/company-detail/section-basisgegevens.tsx"
      provides: "Section 1: name, warmup_start_date, go_live_date, email, phone"
      exports: ["SectionBasisgegevens"]
    - path: "src/components/companies/company-detail/section-klantprofiel.tsx"
      provides: "Section 2: client_notes, personality_score"
      exports: ["SectionKlantprofiel"]
    - path: "src/components/companies/company-detail/section-mailvarianten.tsx"
      provides: "Section 3: mail_variant_1, mail_variant_2, mail_variant_3"
      exports: ["SectionMailvarianten"]
    - path: "src/components/companies/company-detail/section-feedback.tsx"
      provides: "Section 4: feedback_mailvarianten, toekomstige_wensen, extra_notes"
      exports: ["SectionFeedback"]
  key_links:
    - from: "src/app/bedrijven/[id]/page.tsx"
      to: "src/components/companies/company-detail/company-detail-page.tsx"
      via: "renders CompanyDetailPage with companyId prop"
      pattern: "CompanyDetailPage.*companyId"
    - from: "src/components/companies/company-detail/company-detail-page.tsx"
      to: "src/lib/companies.ts"
      via: "getCompanyById on mount, updateCompany on save"
      pattern: "getCompanyById|updateCompany"
    - from: "src/components/companies/company-detail/company-detail-page.tsx"
      to: "src/hooks/use-auto-save.ts"
      via: "useAutoSave hook for save state management"
      pattern: "useAutoSave"
    - from: "section components"
      to: "company-detail-page.tsx"
      via: "receive company state and onFieldBlur callback as props"
      pattern: "onFieldBlur"
---

<objective>
Build the complete company detail page with all 4 sections, auto-save on blur, manual save, and back navigation.

Purpose: This is the core editing experience (COMP-03 through COMP-08). Users edit company data across 4 distinct sections, with changes auto-saving on blur. The page loads company data on mount and provides field-level save with visual feedback. This is where users spend most of their time managing client profiles.

Output: A fully functional /bedrijven/[id] detail page with all fields editable and auto-saving.
</objective>

<execution_context>
@C:\Users\bstei\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\bstei\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-company-management-default-tasks/02-RESEARCH.md

@src/types/database.ts
@src/lib/supabase.ts
@src/lib/companies.ts
@src/lib/dates.ts
@src/components/ui/button.tsx
@src/components/ui/input.tsx
@src/components/ui/textarea.tsx
@src/components/ui/label.tsx
@src/components/ui/separator.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useAutoSave hook, save indicator, personality selector, and dynamic route</name>
  <files>
    src/hooks/use-auto-save.ts
    src/components/companies/company-detail/save-indicator.tsx
    src/components/companies/company-detail/personality-selector.tsx
    src/app/bedrijven/[id]/page.tsx
  </files>
  <action>
    Create `src/hooks/use-auto-save.ts`:
    - Export type `SaveStatus = 'idle' | 'saving' | 'saved' | 'error'`
    - Export `useAutoSave(saveFn: (updates: Record<string, unknown>) => Promise<void>)` hook
    - Returns `{ status: SaveStatus, save: (field: string, value: unknown) => Promise<void>, saveAll: (updates: Record<string, unknown>) => Promise<void> }`
    - `save(field, value)`: clears any existing timeout, sets status='saving', calls `saveFn({ [field]: value })`, on success sets status='saved' then setTimeout 2s to 'idle', on error sets status='error'
    - `saveAll(updates)`: same pattern but sends entire updates object (for manual save button)
    - Use useCallback for both functions. Use useRef for the timeout ID. Cleanup timeout on unmount with useEffect return.
    - 'use client' directive NOT needed (hooks are used within client components but don't need the directive themselves)

    Create `src/components/companies/company-detail/save-indicator.tsx`:
    - 'use client' directive
    - Import SaveStatus type from `@/hooks/use-auto-save`
    - Props: `{ status: SaveStatus }`
    - Renders: idle=nothing, saving=`<Loader2 className="size-3 animate-spin" /> Opslaan...` in text-muted-foreground, saved=`<Check className="size-3" /> Opgeslagen` in text-green-600 dark:text-green-400, error=`Fout bij opslaan` in text-destructive
    - All use text-sm and flex items-center gap-1

    Create `src/components/companies/company-detail/personality-selector.tsx`:
    - 'use client' directive
    - Props: `{ value: number | null; onChange: (score: number) => void }`
    - Renders 5 buttons (1-5) in a flex row with gap-2
    - Each button: `size-9 rounded-full border-2 text-sm font-medium transition-colors`
    - Selected: `bg-primary text-primary-foreground border-primary`
    - Unselected: `border-border hover:border-primary/50 text-muted-foreground`
    - Use `cn()` from `@/lib/utils` for conditional classes
    - type="button" to prevent form submission

    Create `src/app/bedrijven/[id]/page.tsx`:
    - Async Server Component (thin wrapper)
    - Signature: `export default async function Page({ params }: { params: Promise<{ id: string }> })`
    - Await params: `const { id } = await params` (Next.js 16 async params pattern -- CRITICAL)
    - Render: `<CompanyDetailPage companyId={id} />`
    - Import CompanyDetailPage from `@/components/companies/company-detail/company-detail-page`
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - All 4 files exist and export their named exports
  </verify>
  <done>useAutoSave hook manages save status with field-level and bulk save, SaveIndicator shows Dutch status text, PersonalitySelector renders 5 clickable circles, [id]/page.tsx awaits params and renders CompanyDetailPage</done>
</task>

<task type="auto">
  <name>Task 2: Create all 4 section components and the detail page orchestrator</name>
  <files>
    src/components/companies/company-detail/section-basisgegevens.tsx
    src/components/companies/company-detail/section-klantprofiel.tsx
    src/components/companies/company-detail/section-mailvarianten.tsx
    src/components/companies/company-detail/section-feedback.tsx
    src/components/companies/company-detail/company-detail-page.tsx
  </files>
  <action>
    All section components share a common pattern:
    - 'use client' directive
    - Props: `{ company: Company; onFieldChange: (field: string, value: unknown) => void; onFieldBlur: (field: string, value: unknown) => void }`
    - `onFieldChange` updates local state for controlled inputs
    - `onFieldBlur` triggers auto-save via the parent's save function
    - Use Label + Input/Textarea from shadcn/ui for each field
    - Each section wrapped in a div with heading (h2 text-lg font-semibold) and space-y-4

    **section-basisgegevens.tsx** (COMP-03):
    - Fields: name (Input text), warmup_start_date (Input date), go_live_date (Input date), email (Input email), phone (Input tel)
    - Labels: "Bedrijfsnaam", "Warmup startdatum", "Go-live datum", "E-mail klant", "Telefoon klant"
    - Layout: 2-column grid on md+ (`grid grid-cols-1 md:grid-cols-2 gap-4`), name spans full width

    **section-klantprofiel.tsx** (COMP-04):
    - Fields: client_notes (Textarea, rows=4), personality_score (PersonalitySelector component)
    - Labels: "Klantnotities", "Persoonlijkheid (1-5)"
    - Import PersonalitySelector from `./personality-selector`
    - PersonalitySelector onChange calls onFieldBlur directly (no separate blur event for click-based selector)

    **section-mailvarianten.tsx** (COMP-05):
    - Fields: mail_variant_1, mail_variant_2, mail_variant_3 (all Textarea, rows=8)
    - Labels: "Variant 1", "Variant 2", "Variant 3"
    - Layout: 3 columns on lg+ (`grid grid-cols-1 lg:grid-cols-3 gap-4`) -- side by side as specified in COMP-05
    - These are LARGE text blocks, so use generous rows and min-h

    **section-feedback.tsx** (COMP-06):
    - Fields: feedback_mailvarianten (Textarea, rows=4), toekomstige_wensen (Textarea, rows=4), extra_notes (Textarea, rows=4)
    - Labels: "Feedback mailvarianten", "Toekomstige wensen", "Extra shit"
    - Layout: stacked vertically (space-y-4)

    **company-detail-page.tsx** (orchestrator, COMP-03 through COMP-08):
    - 'use client' directive
    - Props: `{ companyId: string }`
    - On mount (useEffect), call `getCompanyById(companyId)`. Store in `company` state (type `Company | null`). Track `loading` state.
    - If loading: show centered "Laden..." text or simple skeleton
    - If no company found: show "Bedrijf niet gevonden" with back link
    - Initialize `useAutoSave` with `async (updates) => { await updateCompany(companyId, updates) }`
    - State management: keep `company` in a single useState. On field change: `setCompany(prev => prev ? { ...prev, [field]: value } : prev)`. On field blur: call `save(field, value)` from useAutoSave.
    - Render layout:
      1. Header row: Back button (Link to /bedrijven with ArrowLeft icon + "Terug naar overzicht") on the left, SaveIndicator + manual "Opslaan" button on the right
      2. Manual save button: Button with Save icon, onClick calls `saveAll` with ALL current company fields (excluding id, created_at, updated_at). Disabled when status is 'saving'.
      3. Separator between header and sections
      4. Four sections in order, each separated by a Separator component:
         - SectionBasisgegevens
         - SectionKlantprofiel
         - SectionMailvarianten
         - SectionFeedback
      5. Pass `company`, `onFieldChange`, `onFieldBlur` to each section
    - onFieldChange: `(field, value) => setCompany(prev => prev ? { ...prev, [field]: value } : prev)`
    - onFieldBlur: `(field, value) => save(field, value)` -- triggers auto-save for that single field
    - Back button: Use Next.js Link (NOT router.back()) for deterministic navigation per RESEARCH.md Pitfall 7

    IMPORTANT: Date fields (warmup_start_date, go_live_date) must stay as YYYY-MM-DD strings. Do NOT convert to Date objects. `<input type="date" value={dateString}>` works directly with ISO date strings. See RESEARCH.md Pitfall 5.

    IMPORTANT: Each auto-save sends only ONE field to updateCompany (partial update). This prevents race conditions when rapidly editing multiple fields. See RESEARCH.md Pitfall 4.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `npm run build` succeeds
    - All 5 files exist with correct exports
    - Verify auto-save wiring: grep for "onFieldBlur" and "save" in company-detail-page.tsx
    - Verify back button uses Link not router.back(): grep for "Link.*bedrijven" in company-detail-page.tsx
  </verify>
  <done>
    All 4 sections render their respective fields with labels and controlled inputs.
    company-detail-page.tsx loads company data, provides auto-save on blur (field-level partial updates), shows SaveIndicator, has manual save button, and has Link-based back button to /bedrijven.
    The complete detail page is accessible at /bedrijven/[id].
  </done>
</task>

</tasks>

<verification>
- `npm run build` succeeds
- /bedrijven/[id] route resolves (Next.js generates the dynamic route)
- TypeScript compiles cleanly for all 9 new files
- Section components receive company data and trigger auto-save on blur
- Back button links to /bedrijven (not router.back)
- Manual save button exists alongside auto-save
</verification>

<success_criteria>
- COMP-03: Basisgegevens section shows name, warmup_start_date, go_live_date, email, phone
- COMP-04: Klantprofiel section shows client_notes textarea and personality 1-5 visual selector
- COMP-05: Mailvarianten section shows 3 large text blocks side by side
- COMP-06: Feedback section shows feedback_mailvarianten, toekomstige_wensen, extra_notes
- COMP-07: Fields auto-save on blur with "Opslaan..."/"Opgeslagen" indicator, manual save button as fallback
- COMP-08: Back button navigates to /bedrijven via Link (deterministic, not history-based)
- All editable fields use controlled state and onBlur saves
- Partial updates (single field) sent to prevent race conditions
</success_criteria>

<output>
After completion, create `.planning/phases/02-company-management-default-tasks/02-04-SUMMARY.md`
</output>
