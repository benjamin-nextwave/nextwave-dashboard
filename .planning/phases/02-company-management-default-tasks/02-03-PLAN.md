---
phase: 02-company-management-default-tasks
plan: 03
type: execute
wave: 2
depends_on: ["02-01", "02-02"]
files_modified:
  - src/app/bedrijven/page.tsx
  - src/components/companies/company-grid.tsx
  - src/components/companies/company-card.tsx
  - src/components/companies/create-company-dialog.tsx
autonomous: true

must_haves:
  truths:
    - "Bedrijven page shows a grid of company cards"
    - "Each card displays company name, go-live date, and open task count"
    - "Clicking + Nieuw bedrijf opens a creation dialog"
    - "Submitting the dialog creates a company AND 6 default tasks"
    - "After creation, the grid refreshes to show the new company"
    - "Clicking a company card navigates to /bedrijven/[id]"
  artifacts:
    - path: "src/app/bedrijven/page.tsx"
      provides: "Bedrijven route rendering CompanyGrid"
      min_lines: 5
    - path: "src/components/companies/company-grid.tsx"
      provides: "Client component fetching and displaying company cards"
      min_lines: 40
    - path: "src/components/companies/company-card.tsx"
      provides: "Single company card with name, go-live date, open tasks"
      min_lines: 20
    - path: "src/components/companies/create-company-dialog.tsx"
      provides: "Dialog with name, warmup_start_date, go_live_date fields"
      min_lines: 60
  key_links:
    - from: "src/components/companies/company-grid.tsx"
      to: "src/lib/companies.ts"
      via: "getCompaniesWithOpenTaskCounts call"
      pattern: "getCompaniesWithOpenTaskCounts"
    - from: "src/components/companies/create-company-dialog.tsx"
      to: "src/lib/companies.ts"
      via: "createCompany call"
      pattern: "createCompany"
    - from: "src/components/companies/create-company-dialog.tsx"
      to: "src/lib/default-tasks.ts"
      via: "generateDefaultTasks + insertDefaultTasks"
      pattern: "generateDefaultTasks|insertDefaultTasks"
    - from: "src/components/companies/company-card.tsx"
      to: "/bedrijven/[id]"
      via: "Next.js Link"
      pattern: "href=.*bedrijven/"
---

<objective>
Build the company overview page with card grid, company creation dialog, and default task generation on create.

Purpose: This is the entry point for company management (COMP-01, COMP-02). Users see all their companies at a glance and can create new ones. Creating a company triggers default task generation (DTSK-01 through DTSK-08), which is the core automation of this phase.

Output: A working /bedrijven page with company cards and a "+ Nieuw bedrijf" creation flow.
</objective>

<execution_context>
@C:\Users\bstei\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\bstei\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-company-management-default-tasks/02-RESEARCH.md

@src/types/database.ts
@src/lib/supabase.ts
@src/lib/companies.ts
@src/lib/tasks.ts
@src/lib/default-tasks.ts
@src/lib/dates.ts
@src/components/ui/card.tsx
@src/components/ui/badge.tsx
@src/components/ui/dialog.tsx
@src/components/ui/input.tsx
@src/components/ui/label.tsx
@src/components/ui/button.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create company card and grid components</name>
  <files>
    src/components/companies/company-card.tsx
    src/components/companies/company-grid.tsx
    src/app/bedrijven/page.tsx
  </files>
  <action>
    Create `src/components/companies/company-card.tsx`:
    - NOT a client component (no interactivity on the card itself, Link handles navigation)
    - Props: `{ id: string; name: string; goLiveDate: string | null; openTaskCount: number }`
    - Renders a shadcn Card wrapped in a Next.js Link to `/bedrijven/${id}`
    - CardHeader: company name as CardTitle
    - CardContent: go-live date formatted with `formatShortDate` from `@/lib/dates` (or "Geen go-live datum" if null), and a Badge showing `{openTaskCount} open`
    - Hover state: `hover:border-primary/50 transition-colors cursor-pointer`
    - Use semantic color classes (text-muted-foreground for dates, etc.)

    Create `src/components/companies/company-grid.tsx`:
    - 'use client' directive (manages state and fetches data)
    - On mount (useEffect), call `getCompaniesWithOpenTaskCounts()` from `@/lib/companies`
    - Store companies in state, track loading state
    - Show loading skeleton or text while fetching
    - Render a header row with "Bedrijven" title and the CreateCompanyDialog (to be created in Task 2)
    - Render companies in a responsive CSS grid: `grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4`
    - Map companies to CompanyCard components
    - Show "Nog geen bedrijven" message when list is empty (after loading)
    - Export a `refreshCompanies` callback that re-fetches and pass it to CreateCompanyDialog as `onCreated` prop

    Update `src/app/bedrijven/page.tsx`:
    - Replace the placeholder content with: `<main className="p-6"><CompanyGrid /></main>`
    - Import CompanyGrid from `@/components/companies/company-grid`
    - Keep it as a Server Component (CompanyGrid is the client boundary)
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `npm run build` succeeds
    - Visually: /bedrijven renders CompanyGrid (may show "Nog geen bedrijven" if no data, or loading state)
  </verify>
  <done>CompanyCard renders name/date/count in a linked Card, CompanyGrid fetches companies and renders them in a responsive grid, bedrijven/page.tsx renders CompanyGrid</done>
</task>

<task type="auto">
  <name>Task 2: Create company creation dialog with default task generation</name>
  <files>
    src/components/companies/create-company-dialog.tsx
  </files>
  <action>
    Create `src/components/companies/create-company-dialog.tsx`:
    - 'use client' directive
    - Props: `{ onCreated: () => void }` (callback to refresh parent grid)
    - Uses shadcn Dialog with DialogTrigger as a Button: `<Plus className="size-4" /> Nieuw bedrijf`
    - Dialog content has DialogHeader with DialogTitle "Nieuw bedrijf aanmaken"
    - Form with 3 fields:
      1. "Bedrijfsnaam" -- Input type="text", required
      2. "Warmup startdatum" -- Input type="date", required
      3. "Go-live datum" -- Input type="date", optional
    - Each field: Label + Input, wrapped in `div className="space-y-2"`
    - Form wrapping: `form onSubmit={handleSubmit} className="space-y-4"`
    - Submit button: "Aanmaken" (full width), disabled while submitting, shows "Aanmaken..." while loading
    - Controlled state: useState for name, warmupStartDate, goLiveDate, open, isSubmitting

    handleSubmit logic (sequential, NOT parallel):
    1. Prevent default, validate name and warmupStartDate are present
    2. Set isSubmitting = true
    3. Call `createCompany({ name, warmup_start_date: warmupStartDate, go_live_date: goLiveDate || null })`
    4. Call `generateDefaultTasks(company.id, warmupStartDate)` to get task objects
    5. Call `insertDefaultTasks(tasks)` to batch-insert all 6 tasks
    6. Reset form fields, close dialog (setOpen false)
    7. Call onCreated() to refresh the grid
    8. Wrap in try/catch, console.error on failure, set isSubmitting = false in finally

    Imports:
    - `createCompany` from `@/lib/companies`
    - `generateDefaultTasks` from `@/lib/default-tasks`
    - `insertDefaultTasks` from `@/lib/tasks`
    - shadcn Dialog, Button, Input, Label from their ui paths
    - Plus icon from lucide-react

    Reference RESEARCH.md Pattern 5 and Code Examples section for the full pattern.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `npm run build` succeeds
    - Verify the import chain: dialog imports createCompany, generateDefaultTasks, insertDefaultTasks
  </verify>
  <done>CreateCompanyDialog opens a modal with name/warmup/golive fields, creates company in Supabase, generates and inserts 6 default tasks, closes dialog and triggers grid refresh</done>
</task>

</tasks>

<verification>
- `npm run build` succeeds
- /bedrijven page renders company grid (empty state or with data)
- "+ Nieuw bedrijf" button is visible in the page header
- TypeScript compiles cleanly
- All imports resolve (companies.ts, tasks.ts, default-tasks.ts, UI components)
</verification>

<success_criteria>
- COMP-01: Company overview page shows responsive grid of cards with name, go-live date, open task count
- COMP-02: "+ Nieuw bedrijf" button opens creation dialog with name, warmup start date, go-live date
- DTSK-01: Creating a company auto-generates 6 default tasks via generateDefaultTasks + insertDefaultTasks
- Company cards link to /bedrijven/[id] for the detail page
- Grid refreshes after company creation without page reload
</success_criteria>

<output>
After completion, create `.planning/phases/02-company-management-default-tasks/02-03-SUMMARY.md`
</output>
